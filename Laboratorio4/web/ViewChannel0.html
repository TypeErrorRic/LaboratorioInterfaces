<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analog Channel Live Chart</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <style>
    body { background: #0d1117; color: #e6edf3; }
    .card { background: #161b22; border-color: #30363d; }
    .badge-status { min-width: 110px; }
    .recent-table { min-width: 180px; max-width: 220px; }
    .recent-table .card-header {
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 25px;
      color: #fff;
      font-weight: 700;
    }
    .recent-table .card-header .fw-bold { font-size: 0.85rem; }
    .recent-table table th,
    .recent-table table td { text-align: center; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex align-items-center mb-4">
      <div>
        <h1 id="pageTitle" class="h3 mb-1">Canal Analógico</h1>
        <p class="mb-0 text-secondary">Datos vs. tiempo desde int_proceso_vars_data</p>
      </div>
      <div class="ms-auto d-flex gap-2">
        <span id="connStatus" class="badge bg-danger badge-status">Desconectado</span>
        <span id="lastUpdate" class="badge bg-secondary">Última actualización: --</span>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <span class="badge bg-primary me-2">Var ID: <span id="varIdLabel">--</span></span>
            <span class="badge bg-info text-dark">Channel: <span id="channelLabel">ADC?</span></span>
          </div>
          <div class="text-end">
            <div class="text-secondary small">Latest value</div>
            <div id="latestValue" class="h4 mb-0">--</div>
          </div>
        </div>
        <div class="d-lg-flex align-items-start gap-3">
          <div class="flex-grow-1 mb-3 mb-lg-0">
            <canvas id="chart" height="120"></canvas>
          </div>
          <div class="recent-table card bg-dark border-secondary flex-shrink-0">
            <div class="card-header py-2">
              <div class="fw-bold">Historial</div>
            </div>
            <div class="table-responsive">
              <table class="table table-sm table-dark mb-0">
                <thead>
                  <tr>
                    <th scope="col">Valor</th>
                    <th scope="col">Tiempo (s)</th>
                  </tr>
                </thead>
                <tbody id="recentTableBody">
                  <tr><td colspan="2" class="text-center text-secondary small">Sin datos</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Config
    const qs = new URLSearchParams(location.search);
    const WS_PORT = 8090;
    const channel = 0; // Este archivo siempre muestra ADC0
    const WS_URL = `ws://${location.hostname}:${WS_PORT}`;
    const ANALOG_BASE_ID = 10;
    const VAR_ID = ANALOG_BASE_ID + channel;
    const MAX_POINTS = 300;
    const WINDOW_S = 10; // Mostrar solo los ultimos 10 segundos

    // Elements
    const connStatusEl = document.getElementById('connStatus');
    const lastUpdateEl = document.getElementById('lastUpdate');
    const latestValueEl = document.getElementById('latestValue');
    const varIdLabel = document.getElementById('varIdLabel');
    const channelLabel = document.getElementById('channelLabel');
    const pageTitle = document.getElementById('pageTitle');
    const recentTableBody = document.getElementById('recentTableBody');
    varIdLabel.textContent = VAR_ID;
    channelLabel.textContent = `ADC${channel}`;
    pageTitle.textContent = `Canal Analógico ADC${channel}`;

    let ws;
    let chart;
    let baseTime = null; // Guarda la primera marca de tiempo para iniciar el eje X en 0

    function setStatus(connected) {
      connStatusEl.textContent = connected ? 'Connected' : 'Disconnected';
      connStatusEl.className = `badge badge-status ${connected ? 'bg-success' : 'bg-danger'}`;
    }

    function formatTime(ts = Date.now()) {
      return new Date(ts).toLocaleTimeString();
    }

    function adcToVoltage(adcValue) {
      // Arduino Uno: 10-bit ADC (0-1023) con referencia de 5V
      return ((adcValue / 1023) * 5.0).toFixed(3);
    }

    function initChart() {
      const ctx = document.getElementById('chart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [{
            label: `ADC${channel}`,
            data: [],
            borderColor: '#4cc9f0',
            backgroundColor: 'rgba(76, 201, 240, 0.1)',
            tension: 0.2,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          animation: false,
          scales: {
            x: {
              type: 'linear',
              title: { display: true, text: 'Tiempo (s)' },
              ticks: { color: '#9ba3af' },
              grid: { color: '#21262d' }
            },
            y: {
              title: { display: true, text: 'Voltaje (V)' },
              ticks: { 
                color: '#9ba3af',
                callback: function(value) {
                  return value.toFixed(2) + ' V';
                }
              },
              grid: { color: '#21262d' },
              min: 0,
              max: 5
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => ` Voltaje: ${ctx.parsed.y.toFixed(3)} V (t=${ctx.parsed.x.toFixed(2)} s)`
              }
            }
          }
        }
      });
    }

    function updateRecentTable(dataset) {
      recentTableBody.innerHTML = '';
      const rows = dataset.slice(-10).reverse();
      if (rows.length === 0) {
        recentTableBody.innerHTML = '<tr><td colspan="2" class="text-center text-secondary small">Sin datos</td></tr>';
        return;
      }

      rows.forEach(point => {
        const tr = document.createElement('tr');
        const valTd = document.createElement('td');
        const timeTd = document.createElement('td');
        valTd.textContent = `${point.y.toFixed(3)} V`;
        timeTd.textContent = point.x.toFixed(2);
        tr.appendChild(valTd);
        tr.appendChild(timeTd);
        recentTableBody.appendChild(tr);
      });
    }

    function handleVarsData(rows) {
      const dataset = chart.data.datasets[0].data;
      const filtered = rows.filter(r => r.int_proceso_vars_id === VAR_ID);
      if (filtered.length === 0) return;

      filtered.forEach(row => {
        const time = Number(row.tiempo);
        if (baseTime === null) baseTime = time;
        const voltage = (Number(row.valor) / 1023) * 5.0;
        dataset.push({ x: (time - baseTime) / 1000, y: voltage });
      });

      dataset.sort((a, b) => a.x - b.x);

      // Mantener una ventana movil de 10 segundos
      const latestX = dataset.length ? dataset[dataset.length - 1].x : null;
      if (latestX !== null) {
        const minWindow = latestX - WINDOW_S;
        while (dataset.length && dataset[0].x < minWindow) {
          dataset.shift();
        }
        chart.options.scales.x.min = Math.max(0, minWindow);
        chart.options.scales.x.max = latestX;
      }

      if (dataset.length > MAX_POINTS) {
        dataset.splice(0, dataset.length - MAX_POINTS);
      }

      const latest = filtered[filtered.length - 1];
      latestValueEl.textContent = `${adcToVoltage(latest.valor)} V`;
      lastUpdateEl.textContent = `Last update: ${formatTime()}`;
      updateRecentTable(dataset);
      chart.update('none');
    }

    function connect() {
      ws = new WebSocket(WS_URL);

      ws.onopen = () => setStatus(true);
      ws.onclose = () => {
        setStatus(false);
        setTimeout(connect, 2000);
      };
      ws.onerror = () => setStatus(false);
      ws.onmessage = evt => {
        try {
          const payload = JSON.parse(evt.data);
          if (payload.type === 'vars_data' && Array.isArray(payload.data)) {
            handleVarsData(payload.data);
          }
        } catch (err) {
          console.error('Failed to parse message', err);
        }
      };
    }

    initChart();
    connect();
  </script>
</body>
</html>
